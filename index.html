<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiple Browser Window Sync Demo, weeee</title>

    <script>
      window.onbeforeunload = removeWindow;

      function getWindowsFromLocalStorage() {
        var windows = JSON.parse(localStorage.getItem('windows'));

        return windows;
      }

      function registerCurrentWindow () {
        var identifier = windowIdentifier();
        var rawData = localStorage.getItem("windows")
        var windows = getWindowsFromLocalStorage()
        if (windows) {
          if (windows.includes(identifier)) {
            // window identifier already exists
            return identifier;
          } else {
            self.window.name = identifier;
            windows.push(identifier);
          }
        } else {
          self.window.name = identifier;
          windows = [identifier];
        }

        setWindowsFromLocalStorage(windows);

        return identifier;
      }

      function setWindowsFromLocalStorage(windows) {
        localStorage.setItem("windows", JSON.stringify(windows));
      }

      function windowIdentifier() {
        if (self.window.name) {
          // We've already created an identifier for this window
          return self.window.name;
        } else {
          // create new window identifier
          var identifier = Math.random().toString(36).slice(2, 12);
          return identifier;
        }
      }

      function removeFromWindows (identifier) {
        var windows = getWindowsFromLocalStorage();

        // /Remove item from array
        var index = windows.indexOf(identifier);
        if (index > -1) {
          windows.splice(index, 1);
        }
      }

      function removeWindow () {
        var identifier = windowIdentifier();
        localStorage.removeItem(identifier);
        removeFromWindows(identifier);
      }

      function update() {
        var width = visualViewport.width;
        var height = visualViewport.height;
        var left = window.screenX;
        var top = window.screenY;

        var data = {
          height: height,
          left: left,
          top: top,
          width: width,
        }

        // save identifier to local storage
        var identifier = registerCurrentWindow();

        localStorage.setItem(identifier, JSON.stringify(data))

        var windows = getWindowsFromLocalStorage();
        windows.forEach(function (identifier) {
          var dimensions = JSON.parse(localStorage.getItem(identifier));
          console.log(dimensions, identifier);
        });
      }

      setInterval(update, 1000);
    </script>
  </head>
  <body>

  </body>
</html>
